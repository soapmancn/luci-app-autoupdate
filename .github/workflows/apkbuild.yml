name: APKBUILD Package

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Build APK package in Alpine
        uses: addnab/docker-run-action@v3
        with:
          image: alpine:edge
          options: -v ${{ github.workspace }}:/workspace
          run: |
            # 系统配置
            echo "https://downloads.openwrt.org/releases/packages/x86_64/packages" >> /etc/apk/repositories
            apk update
            apk add alpine-sdk build-base fakeroot sudo git luci-base rpcd
            
            # 用户配置
            adduser -D builder
            echo "builder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
            addgroup builder abuild
            
            # 目录权限
            mkdir -p /var/cache/distfiles
            chown builder:abuild /var/cache/distfiles
            chown -R builder:abuild /workspace
            
            # 构建过程
            su builder -c "
              cd /workspace
              git config --global --unset http.https://github.com/.extraheader || true
              export PACKAGER='GitHub Actions <github@actions>'
              abuild-keygen -a -i -n
              abuild checksum
              abuild -r
            "
            
            # 复制构建结果
            find /home/builder/packages -name '*.apk' -exec cp {} /workspace/ \;

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-packages
          path: |
            ./*.apk
            ./src/*.apk
